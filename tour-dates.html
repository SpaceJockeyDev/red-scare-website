<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <link rel="stylesheet" type="text/css" href="styles.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <link rel="icon" href="assets/fist.ico" />
    <title>Tour Dates - Red Scare</title>
    <style>
      a {
        color: red;
      }
      #bands p {
        margin: 0;
      }
      .ticket-link:hover {
        color: red;
      }
      #bands {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: "Alte", sans-serif;
      }
      .band-section {
        margin-bottom: 100px; /* Adjust as needed */
      }
      body {
        background-image: url("assets/bgright.png"), url("assets/bgleft.png");
        background-repeat: repeat-y, repeat-y;
        background-position: right, left;
        background-size: 25%, 25%;
      }
      #bands img {
        max-width: 20%;
        height: auto;
      }
      .band-name {
        font-size: 35px;
        color: #000;
        font-family: "Viva";
      }
      .title-container {
        text-align: center;
      }
      .title {
        display: inline-block;
        border-bottom: 5px solid rgb(252, 4, 4); /* Adjust as needed */
      }
      @media (max-width: 600px) {
        #bands {
          font-size: 14px;
          margin-right: 10px;
          margin-left: -10px;
        }
        #bands h1 {
          font-size: 1.5em;
        }
        #bands img {
          max-width: 50%;
          height: auto;
        }
        body {
          background-size: 8%, 10%; /* Adjust as needed */
          background-repeat: repeat-y, repeat-y;
          background-image: url("assets/bgrightmobile.png"),
            url("assets/bgleftmobile.png");
        }
      }
    </style>
  </head>
  <body>
    <div id="navbar-container"></div>

    <div class="title-container">
      <h1 class="title" style="font-family: 'Viva'">Tour Dates</h1>
    </div>

    <div id="bands"></div>

    <div id="footer"></div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      $(function () {
        $("#navbar-container").load("navigation.html");
      });
    </script>
    <script>
      $(function () {
        $("#footer").load("footer.html");
      });
    </script>
    <script>
      function decodeHtml(html) {
        var txt = document.createElement("textarea");
        txt.innerHTML = html;
        return txt.value;
      }
    </script>
    <script>
      function fetchAllPages(url, page = 1, events = []) {
        return fetch(`${url}?page=${page}`)
          .then((response) => response.json())
          .then((data) => {
            const allEvents = events.concat(data.events);
            if (data.next_rest_url) {
              return fetchAllPages(url, page + 1, allEvents);
            } else {
              return allEvents;
            }
          });
      }

      Promise.all([
        fetchAllPages(
          "https://www.redscare.net/site/wp-json/tribe/events/v1/events"
        ),
        fetch("bands.json").then((response) => response.json()),
      ])
        .then(([apiData, bandsData]) => {
          const bandsDiv = document.getElementById("bands");
          const today = new Date();
          today.setHours(0, 0, 0, 0); // Set the time to 00:00:00 for accurate comparison

          bandsData.forEach((band) => {
            const bandEvents = apiData.filter(
              (event) =>
                band.bandName === event.title &&
                new Date(event.start_date) >= today
            );

            if (bandEvents.length > 0) {
              const bandImage = document.createElement("img");
              bandImage.src = band.picture; // Use the image from the bandsData
              bandsDiv.appendChild(bandImage);

              const bandName = document.createElement("h2");
              bandName.textContent = decodeHtml(band.bandName); // Decode HTML entities in the band name
              bandName.className = "band-name";
              bandsDiv.appendChild(bandName);

              const tourDatesList = document.createElement("ul");
              tourDatesList.style.listStyleType = "none";
              tourDatesList.style.marginBottom = "50px";

              bandEvents.forEach((event) => {
                const eventDate = new Date(event.start_date);
                const li = document.createElement("li");

                const formattedDate = eventDate.toLocaleString("en-US", {
                  month: "short",
                  day: "2-digit",
                  year: "numeric",
                });
                li.textContent = `${formattedDate} - ${decodeHtml(
                  event.venue.city
                )}, ${decodeHtml(event.venue.stateprovince)} - ${decodeHtml(
                  event.venue.venue
                )}`; // Assuming the city and venue are stored in event.venue.city and event.venue.venue

                if (event.description) {
                  const description = document.createElement("p");
                  description.innerHTML = decodeHtml(event.description); // Decode HTML entities in the description
                  description.style.marginLeft = "0px"; // Indent the description
                  description.style.fontStyle = "italic"; // Make the description italic
                  li.appendChild(description);
                }
                if (event.website) {
                  const a = document.createElement("a");
                  a.href = event.website; // Assuming the link is stored in event.url
                  a.textContent = " Buy Tickets";
                  a.className = "ticket-link";
                  li.appendChild(a);
                }
                tourDatesList.appendChild(li);
              });
              bandsDiv.appendChild(tourDatesList);
            }
          });
        })
        .catch((error) => console.error("Error:", error));
    </script>
  </body>
</html>
